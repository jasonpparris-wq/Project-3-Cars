name: run-pipeline

on:
  workflow_call:
    inputs:
      # --- REQUIRED CORE AML CONTEXT ---
      resource_group:
        required: true
        type: string
      workspace_name:
        required: true
        type: string

      # --- PIPELINE DEFINITION FILE(S) ---
      pipeline_file:
        required: true
        type: string
      parameters_file:
        required: true
        type: string

      # --- THESE WERE MISSING (YOUR ERROR) ---
      name:
        required: true
        type: string
      data_file:
        required: true
        type: string

    secrets:
      creds:
        required: true

jobs:
  run_pipeline:
    name: Run Azure ML Pipeline
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.creds }}

      - name: Install Azure ML CLI extension
        shell: bash
        run: |
          set -e
          az version
          az extension add -n ml -y || az extension update -n ml

      - name: Echo inputs (debug)
        shell: bash
        run: |
          echo "resource_group:  ${{ inputs.resource_group }}"
          echo "workspace_name:  ${{ inputs.workspace_name }}"
          echo "pipeline_file:   ${{ inputs.pipeline_file }}"
          echo "parameters_file:${{ inputs.parameters_file }}"
          echo "name:           ${{ inputs.name }}"
          echo "data_file:      ${{ inputs.data_file }}"

      # NOTE:
      # This step submits your pipeline job. The exact --set paths depend on how your pipeline YAML defines inputs.
      # This version submits the pipeline YAML and uses the parameters file if your pipeline references it internally.
      # If your pipeline expects different input names, adjust the --set lines accordingly.
      - name: Submit pipeline job
        shell: bash
        run: |
          set -e

          # Sanity checks so failures are obvious
          test -f "${{ inputs.pipeline_file }}" || (echo "Missing pipeline_file" && exit 1)
          test -f "${{ inputs.parameters_file }}" || (echo "Missing parameters_file" && exit 1)

          echo "Submitting Azure ML pipeline job..."

          az ml job create \
            --file "${{ inputs.pipeline_file }}" \
            --resource-group "${{ inputs.resource_group }}" \
            --workspace-name "${{ inputs.workspace_name }}" \
            --set display_name="${{ inputs.name }}" \
            --set experiment_name="${{ inputs.name }}" \
            --set inputs.data_file="${{ inputs.data_file }}" \
            --stream

      - name: Done
        shell: bash
        run: echo "Pipeline submission step completed."
